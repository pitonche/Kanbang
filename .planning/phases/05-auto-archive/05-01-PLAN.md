---
phase: 05-auto-archive
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/tasks.ts
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "Done tasks with completedAt older than 14 days are automatically moved to archived status when the app loads"
    - "Archived tasks have an archivedAt timestamp set"
    - "Archived tasks do not appear on the board columns"
  artifacts:
    - path: "convex/schema.ts"
      provides: "archived literal in column union, by_column_completedAt compound index"
      contains: "v.literal(\"archived\")"
    - path: "convex/tasks.ts"
      provides: "archiveOldDone mutation, listArchived query, list query excluding archived"
      exports: ["archiveOldDone", "listArchived", "list"]
    - path: "src/App.tsx"
      provides: "Archive trigger on mount via useEffect with StrictMode guard"
      contains: "archiveOldDone"
  key_links:
    - from: "src/App.tsx"
      to: "convex/tasks.ts (archiveOldDone)"
      via: "useMutation + useEffect on mount"
      pattern: "useMutation.*archiveOldDone"
    - from: "convex/tasks.ts (archiveOldDone)"
      to: "convex/schema.ts (by_column_completedAt index)"
      via: "withIndex query for done tasks older than 14 days"
      pattern: "withIndex.*by_column_completedAt"
    - from: "convex/tasks.ts (list)"
      to: "board columns"
      via: "filter excluding archived column"
      pattern: "neq.*column.*archived"
---

<objective>
Add the auto-archive backend: extend the schema with "archived" column value and compound index, create the archiveOldDone mutation, modify the list query to exclude archived tasks, add a listArchived query, and trigger archiving on app load.

Purpose: ARCH-01 and ARCH-02 -- Done tasks older than 14 days auto-archive on app load with archivedAt timestamp. The board stays clean by excluding archived tasks from the list query.
Output: Schema with "archived" column, archiveOldDone mutation, modified list query, listArchived query, App.tsx mount trigger.
</objective>

<execution_context>
@/Users/ciciban/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ciciban/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-auto-archive/05-RESEARCH.md

@convex/schema.ts
@convex/tasks.ts
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema update and Convex backend functions</name>
  <files>convex/schema.ts, convex/tasks.ts</files>
  <action>
  **convex/schema.ts:**
  1. Add `v.literal("archived")` to the `column` union (after `v.literal("done")`).
  2. Add a compound index: `.index("by_column_completedAt", ["column", "completedAt"])` after the existing `by_column` index.

  **convex/tasks.ts:**
  3. Add `archiveOldDone` mutation (no args). Handler:
     - Compute `fourteenDaysAgo = Date.now() - 14 * 24 * 60 * 60 * 1000` and `now = Date.now()`.
     - Query `ctx.db.query("tasks").withIndex("by_column_completedAt", (q) => q.eq("column", "done").lt("completedAt", fourteenDaysAgo)).collect()`.
     - Loop and `ctx.db.patch(task._id, { column: "archived", archivedAt: now, updatedAt: now })` for each.
  4. Modify the existing `list` query to add `.filter((q) => q.neq(q.field("column"), "archived"))` before `.collect()`, so archived tasks never appear on the board.
  5. Add `listArchived` query (no args). Handler: `ctx.db.query("tasks").withIndex("by_column", (q) => q.eq("column", "archived")).collect()`. This returns all archived tasks for the Archive view (Plan 02).

  Import `mutation` is already imported in tasks.ts. No new imports needed for schema.ts.

  Note: The `moveToColumn` mutation's `column` arg validator should NOT include "archived" -- users don't drag tasks to archive. Leave its validator as-is (6 board columns only).
  </action>
  <verify>Run `npx convex dev` (or check that the running dev server picks up changes without errors). Run `npx tsc --noEmit` to verify TypeScript compiles. Confirm no type errors from the schema change or new functions.</verify>
  <done>Schema has "archived" in column union and by_column_completedAt index. tasks.ts exports archiveOldDone mutation, listArchived query, and list query excludes archived tasks.</done>
</task>

<task type="auto">
  <name>Task 2: Trigger archive on app load in App.tsx</name>
  <files>src/App.tsx</files>
  <action>
  1. Add imports: `useMutation` from `"convex/react"`, `api` from `"../convex/_generated/api"`, `useRef` (already imported).
  2. Inside the `App` component, after the existing state declarations:
     - `const archiveOldDone = useMutation(api.tasks.archiveOldDone);`
     - `const archiveTriggered = useRef(false);`
     - Add a `useEffect` that checks `if (!archiveTriggered.current)`, sets `archiveTriggered.current = true`, then calls `archiveOldDone()`. Dependency array: `[archiveOldDone]`.
  3. The `useRef` guard prevents double-execution in React StrictMode (development mode mounts components twice).
  4. This is fire-and-forget -- no need to await the mutation. The Board's `useQuery(api.tasks.list)` will reactively update when archived tasks are removed from the list results.

  Do NOT add view switching or navigation in this task -- that is Plan 02.
  </action>
  <verify>Run `npx tsc --noEmit` to verify no type errors. Open the app in the browser -- confirm no console errors on load. If there are Done tasks older than 14 days, they should disappear from the board after the page loads.</verify>
  <done>App.tsx triggers archiveOldDone mutation once on mount with StrictMode guard. Archived tasks no longer appear on the board.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors.
2. Convex dev server shows no deployment errors for the schema change and new functions.
3. The `archiveOldDone` mutation exists and can be called (check Convex dashboard or browser network tab for the mutation call on page load).
4. The `list` query no longer returns tasks with `column === "archived"`.
5. The `listArchived` query returns only tasks with `column === "archived"`.
6. The Board columns do not show any archived tasks.
</verification>

<success_criteria>
- Schema includes `v.literal("archived")` in column union and `by_column_completedAt` compound index
- `archiveOldDone` mutation finds Done tasks older than 14 days, patches them to `column: "archived"` with `archivedAt` timestamp
- `list` query excludes archived tasks via `.filter(q => q.neq(q.field("column"), "archived"))`
- `listArchived` query returns archived tasks via `by_column` index
- App.tsx fires `archiveOldDone` once on mount with `useRef` StrictMode guard
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/05-auto-archive/05-01-SUMMARY.md`
</output>
