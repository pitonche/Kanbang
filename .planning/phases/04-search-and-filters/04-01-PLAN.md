---
phase: 04-search-and-filters
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/tasks.ts
  - src/hooks/useDebounce.ts
  - src/components/SearchBar.tsx
  - src/components/Board.tsx
autonomous: true

must_haves:
  truths:
    - "User can type a keyword into a search bar above the board and see matching tasks"
    - "Search matches against both task title and notes content (via composite searchText field)"
    - "Search results include both active and archived tasks (no column/archive filter on query)"
    - "Clearing the search input returns the user to the normal board view"
    - "Search input is debounced so queries only fire after the user stops typing"
  artifacts:
    - path: "convex/tasks.ts"
      provides: "tasks.search query function using withSearchIndex"
      exports: ["search"]
    - path: "src/hooks/useDebounce.ts"
      provides: "useDebounce generic custom hook"
      exports: ["useDebounce"]
    - path: "src/components/SearchBar.tsx"
      provides: "Search input with clear button"
      exports: ["SearchBar"]
    - path: "src/components/Board.tsx"
      provides: "Toolbar with SearchBar, conditional search results vs board view"
  key_links:
    - from: "src/components/Board.tsx"
      to: "convex/tasks.ts (search)"
      via: "useQuery(api.tasks.search, ...) with skip pattern"
      pattern: "useQuery.*api\\.tasks\\.search"
    - from: "src/components/Board.tsx"
      to: "src/hooks/useDebounce.ts"
      via: "useDebounce(searchTerm, 300)"
      pattern: "useDebounce.*searchTerm.*300"
    - from: "src/components/Board.tsx"
      to: "src/components/SearchBar.tsx"
      via: "SearchBar rendered in toolbar div above the board"
      pattern: "<SearchBar"
---

<objective>
Add full-text search across all tasks (active and archived) using Convex's withSearchIndex, with a debounced search bar in a new toolbar above the board.

Purpose: Enables SRCH-01 (search by keyword) and SRCH-02 (includes archived tasks). The user can find any task by typing a keyword.
Output: tasks.search Convex query, useDebounce hook, SearchBar component, Board.tsx updated with toolbar and search results display.
</objective>

<execution_context>
@/Users/ciciban/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ciciban/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-search-and-filters/04-RESEARCH.md
@convex/schema.ts
@convex/tasks.ts
@src/components/Board.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add search query and useDebounce hook</name>
  <files>convex/tasks.ts, src/hooks/useDebounce.ts</files>
  <action>
**1. Add `search` export to `convex/tasks.ts`:**

Add a new query function after the existing `moveToColumn` mutation:

```typescript
export const search = query({
  args: {
    term: v.string(),
  },
  handler: async (ctx, args) => {
    return await ctx.db
      .query("tasks")
      .withSearchIndex("search_text", (q) =>
        q.search("searchText", args.term)
      )
      .take(20);
  },
});
```

Key details:
- Uses the existing `search_text` search index defined in schema.ts (searchField: "searchText", filterFields: ["column"])
- Does NOT add any `.eq("column", ...)` filter -- this ensures ALL tasks (active and archived) are returned, satisfying SRCH-02
- `.take(20)` limits results to a reasonable count for a personal tool
- Results are ordered by BM25 relevance automatically
- The `query` and `v` imports already exist at the top of the file

**2. Create `src/hooks/useDebounce.ts`:**

Create a new `src/hooks/` directory and add a generic debounce hook:

```typescript
import { useState, useEffect } from "react";

export function useDebounce<T>(value: T, delayMs: number): T {
  const [debounced, setDebounced] = useState(value);

  useEffect(() => {
    const timer = setTimeout(() => setDebounced(value), delayMs);
    return () => clearTimeout(timer);
  }, [value, delayMs]);

  return debounced;
}
```

This is 4 lines of logic. No external dependency needed. Cleans up the timer on unmount/value change via the useEffect return.
  </action>
  <verify>
Run `npx tsc --noEmit` from the project root. Both files should compile without type errors. Verify `convex/tasks.ts` exports `search` and `src/hooks/useDebounce.ts` exports `useDebounce`.
  </verify>
  <done>
`tasks.search` query function exists and accepts a `term` string argument. `useDebounce` hook exists at `src/hooks/useDebounce.ts` and is a generic typed hook. Both compile cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add SearchBar component and integrate search into Board</name>
  <files>src/components/SearchBar.tsx, src/components/Board.tsx</files>
  <action>
**1. Create `src/components/SearchBar.tsx`:**

```tsx
interface SearchBarProps {
  value: string;
  onChange: (value: string) => void;
}

export function SearchBar({ value, onChange }: SearchBarProps) {
  return (
    <div className="relative">
      <svg
        className="absolute left-2.5 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          strokeLinecap="round"
          strokeLinejoin="round"
          strokeWidth={2}
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
        />
      </svg>
      <input
        type="text"
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder="Search tasks... ( / )"
        className="w-64 pl-9 pr-8 py-1.5 text-sm border border-slate-300 rounded-md
                   bg-white focus:outline-none focus:ring-2 focus:ring-slate-400 focus:border-transparent"
      />
      {value && (
        <button
          onClick={() => onChange("")}
          className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 text-sm"
          aria-label="Clear search"
        >
          ✕
        </button>
      )}
    </div>
  );
}
```

Key details:
- Controlled input: parent owns the value/onChange
- Magnifying glass SVG icon on the left
- Clear button (✕) appears only when input has text
- Placeholder hints at the "/" keyboard shortcut (will be wired in Plan 04-02)
- Uses the same Slate color palette as the rest of the app

**2. Modify `src/components/Board.tsx` to add toolbar and search results:**

Add these imports at the top:
```typescript
import { SearchBar } from "./SearchBar";
import { useDebounce } from "../hooks/useDebounce";
```

Add search state inside the `Board` function, after the existing `activeTask` useState:
```typescript
const [searchTerm, setSearchTerm] = useState("");
const debouncedTerm = useDebounce(searchTerm, 300);

const searchResults = useQuery(
  api.tasks.search,
  debouncedTerm.trim() ? { term: debouncedTerm.trim() } : "skip"
);

const isSearchActive = debouncedTerm.trim().length > 0;
```

Restructure the return JSX. Wrap the board content area with a toolbar:

The top-level return should be:
```tsx
return (
  <>
    <DndContext ...existing props...>
      <div className="flex flex-col min-h-screen bg-board-bg">
        {/* Toolbar */}
        <div className="flex items-center gap-4 px-6 pt-4 pb-2">
          <SearchBar value={searchTerm} onChange={setSearchTerm} />
        </div>

        {/* Content area: search results OR board columns */}
        {isSearchActive ? (
          <div className="px-6 py-4">
            {searchResults === undefined ? (
              <p className="text-sm text-slate-500">Searching...</p>
            ) : searchResults.length === 0 ? (
              <p className="text-sm text-slate-500">No tasks found for "{debouncedTerm.trim()}"</p>
            ) : (
              <div className="space-y-2 max-w-2xl">
                <p className="text-xs text-slate-500 mb-3">
                  {searchResults.length} result{searchResults.length !== 1 ? "s" : ""}
                </p>
                {(searchResults as Doc<"tasks">[]).map((task) => {
                  const colLabel = COLUMNS.find((c) => c.id === task.column)?.label ?? task.column;
                  return (
                    <button
                      key={task._id}
                      onClick={() => setSelectedTaskId(task._id)}
                      className="w-full text-left p-3 bg-white rounded-lg border border-slate-200 hover:border-slate-300 transition-colors"
                    >
                      <div className="flex items-center justify-between">
                        <span className="text-sm font-medium text-slate-800">{task.title}</span>
                        <span className="text-xs text-slate-400 ml-2">{colLabel}</span>
                      </div>
                      {task.notes && (
                        <p className="text-xs text-slate-500 mt-1 line-clamp-1">{task.notes}</p>
                      )}
                    </button>
                  );
                })}
              </div>
            )}
          </div>
        ) : (
          <div className="flex gap-4 px-6 pb-6 overflow-x-auto flex-1">
            {COLUMNS.map((col) => (
              <Column
                key={col.id}
                id={col.id}
                label={col.label}
                tasks={tasksByColumn[col.id] ?? []}
                onTaskClick={setSelectedTaskId}
              />
            ))}
          </div>
        )}
      </div>
      <DragOverlay>
        {activeTask ? <TaskCardOverlay task={activeTask} /> : null}
      </DragOverlay>
    </DndContext>
    <TaskModal
      task={selectedTask}
      onClose={() => setSelectedTaskId(null)}
    />
  </>
);
```

Key structural changes to Board.tsx:
- The outer `<div>` changes from `flex gap-4 p-6 overflow-x-auto min-h-screen bg-board-bg` to `flex flex-col min-h-screen bg-board-bg` (column layout to stack toolbar above content)
- The column flex row moves to a nested div with `flex gap-4 px-6 pb-6 overflow-x-auto flex-1`
- A new toolbar div sits above the content area
- When `isSearchActive` is true, the columns are replaced by a search results list
- Search results show as clickable cards with task title, column label, and truncated notes
- Clicking a search result opens the TaskModal (reuses existing `setSelectedTaskId`)
- Loading state shows "Searching..." and empty state shows "No tasks found for [term]"

Important: The DndContext still wraps everything (no-op during search mode since columns aren't rendered), and TaskModal remains outside the DndContext as before.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify type safety. Then run `bun run dev` and verify in the browser:
1. A search bar appears above the board columns
2. Typing a keyword shows matching results (or "No tasks found")
3. Clicking a search result opens the TaskModal
4. Clearing the search (✕ button or deleting text) returns to the normal board
5. The "N" keyboard shortcut still works when not focused in the search input
  </verify>
  <done>
Search bar renders in a toolbar above the board. Typing a keyword queries Convex search and displays results as a flat list replacing the board. Search results are clickable and open TaskModal. Clearing search restores normal board view. Build compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `bun run build` succeeds
3. Search bar visible above the 6-column board
4. Typing a keyword that matches a task title shows results within ~300ms of stopping typing
5. Typing a keyword that matches task notes (not just title) also returns results
6. Search results show tasks from any column (including Done)
7. Clicking a search result opens the TaskModal with that task's details
8. Clearing search input restores the full board with all columns and drag-and-drop
9. "N" keyboard shortcut still works when focus is not in the search input
</verification>

<success_criteria>
- tasks.search Convex query function exists and returns BM25-ranked results from the search_text index
- SearchBar component renders with magnifying glass icon, placeholder, and clear button
- useDebounce hook delays search queries by 300ms after last keystroke
- Board shows search results as a flat list when search is active, replacing the column view
- Search results include tasks regardless of column (active and archived tasks in future)
- Build compiles and app runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-search-and-filters/04-01-SUMMARY.md`
</output>
